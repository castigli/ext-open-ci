ARG BASE_IMAGE=docker.io/ubuntu:24.04
FROM ${BASE_IMAGE}

ARG WORKDIR_PATH=/workspace
ENV WORKDIR=${WORKDIR_PATH}
WORKDIR ${WORKDIR}
ARG PROJECT_REPO=https://github.com/llvm/llvm-project.git
RUN git clone ${PROJECT_REPO}
RUN cd llvm-project && \
    cmake -S llvm -B ../llvm-build-daint-release -G Ninja -DLLVM_ENABLE_PROJECTS="mlir" \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_PARALLEL_LINK_JOBS=2 \
    -DLLVM_ENABLE_ASSERTIONS=ON \
    -DCMAKE_BUILD_TYPE=RelWithDebInfo \
    -DLLVM_CCACHE_BUILD=ON \
    -DLLVM_INSTALL_UTILS=ON \
    -DLLVM_TARGETS_TO_BUILD="host;NVPTX" \
    -DMLIR_ENABLE_BINDINGS_PYTHON=ON \
    -DMLIR_ENABLE_CUDA_RUNNER=ON \
    -DMLIR_ENABLE_NVPTXCOMPILER=ON \
    -DCMAKE_CUDA_ARCHITECTURES="90"
